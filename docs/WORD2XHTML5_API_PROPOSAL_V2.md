# Word2XHTML5サービス 部分API化のご提案

## 宛先
Word2XHTML5サービス（http://trial.nextpublishing.jp/upload_46tate/）管理者様

## 提案者
技術の泉シリーズ制作支援ツール開発チーム

## 日付
2025年1月27日

---

## 1. はじめに

Word2XHTML5変換サービスを日頃より利用させていただき、誠にありがとうございます。本サービスの編集者支援という理念に深く共感し、より効率的な活用方法として、部分的なAPI化のご提案をさせていただきます。

## 2. 現状と課題

### 2.1 本来のサービス提供内容
- **総合的な変換サービス**: PDF、EPUB、画像チェック、ZIPファイル返却
- **Nフォルダでの全体ページ組版前の前処理**
- **編集者支援を目的とした無料提供**

### 2.2 現在の特殊な利用状況
- **PDF変換機能のみを抜き出した利用**
- **エラーファイル監視システムとしての活用**
- **1プロジェクトあたり50-200ファイルの大量処理**
- **Seleniumによる自動化（現状のワークアラウンド）**

### 2.3 技術的な推察
- **処理方式**: セッション単位ではなくストリーム処理の可能性
- **非同期処理**: アップロード→変換→メール送信の一連フロー
- **現在の課題**: 自動化によるサーバー負荷の懸念

## 3. API化提案の概要

### 3.1 提案の基本方針
1. **最小限の実装から開始**
   - PDF変換機能のみのAPI切り出し
   - 既存システムへの影響を最小化
   - 段階的な拡張を前提とした設計

2. **無料提供の継続**
   - 編集者支援という理念の維持
   - API利用も無料を基本とする
   - 利用制限は適正なサーバー負荷管理のためのみ

3. **既存ワークフローとの共存**
   - 現在のWebインターフェースは維持
   - メール通知システムも並行稼働
   - 利用者が選択可能な形での提供

## 4. 技術仕様提案

### 4.1 Option A: 最小限のPDF変換API

```
POST /api/v1/pdf-convert
リクエスト:
{
  "file": "base64_encoded_word_file",
  "filename": "document.docx",
  "callback_url": "https://user-endpoint.com/webhook" (optional)
}

レスポンス:
{
  "job_id": "uuid-string",
  "status": "accepted",
  "message": "処理を受け付けました"
}
```

```
GET /api/v1/pdf-status/{job_id}
レスポンス（処理中）:
{
  "job_id": "uuid-string",
  "status": "processing",
  "progress": 45
}

レスポンス（完了時）:
{
  "job_id": "uuid-string",
  "status": "completed",
  "download_url": "https://...",
  "expires_at": "2025-01-28T12:00:00Z",
  "errors": []
}
```

### 4.2 Option B: 汎用的なAPI設計（将来拡張対応）

```
POST /api/v1/convert
リクエスト:
{
  "file": "base64_encoded_file",
  "filename": "document.docx",
  "output_formats": ["pdf"],  // 将来的に ["pdf", "epub"] など拡張可能
  "options": {
    "image_check": false,     // 将来的な機能拡張用
    "return_zip": false,      // 将来的な機能拡張用
    "skip_email": true        // メール送信をスキップ
  },
  "webhook_url": "https://..." (optional)
}

レスポンス:
{
  "job_id": "uuid-string",
  "accepted_formats": ["pdf"],
  "estimated_time": 30
}
```

### 4.3 非同期処理の考慮

既存のストリーム処理アーキテクチャを活かした設計：

1. **ジョブキューシステム**
   - 既存の処理フローにAPIリクエストを挿入
   - 処理順序の公平性を保証

2. **通知オプション**
   - Webhook通知（推奨）
   - ロングポーリング対応
   - 既存のメール通知も選択可能

3. **エラーハンドリング**
   ```json
   {
     "status": "failed",
     "error": {
       "code": "INVALID_FORMAT",
       "message": "Word文書の形式が無効です",
       "details": "ヘッダー情報が破損しています"
     }
   }
   ```

## 5. 実装における配慮事項

### 5.1 サーバー負荷管理
```
レート制限（案）:
- 同時処理数: 5ファイル/ユーザー
- リクエスト数: 60回/時間
- ファイルサイズ: 50MB以下
- 優先度キュー: 通常のWeb UIを優先
```

### 5.2 認証とセキュリティ
```
最小限の認証:
- シンプルなAPIキー方式
- IPアドレスによるアクセス制限（オプション）
- HTTPS必須
```

### 5.3 互換性の維持
- 既存のWebフォームと同じ検証ロジック
- エラーメッセージの一貫性
- ファイル形式の制限も同一


## 7. 期待される効果

### 7.1 サービス提供側のメリット
1. **負荷の平準化**
   - APIによる計画的なリクエスト分散
   - ピーク時間の回避
   - リソース利用の最適化

2. **利用状況の可視化**
   - API利用統計の収集
   - エラーパターンの把握
   - サービス改善へのフィードバック

3. **新たな価値創出**
   - 大量処理ニーズへの対応
   - 自動化ワークフローの支援
   - 技術書制作の効率化への貢献

### 7.2 利用者側のメリット
1. **作業効率の劇的な改善**
   - 50-200ファイルの自動処理
   - エラーファイルの即時特定
   - 処理状況のリアルタイム把握

2. **品質管理の向上**
   - 系統的なエラーチェック
   - 処理履歴の管理
   - 再現性のある検証プロセス

## 8. リスク評価と対策

| 懸念事項 | 対策案 |
|---------|--------|
| 大量リクエストによる負荷 | レート制限とキューイングシステム |
| 不正利用 | APIキー管理と利用ログ監視 |
| 既存利用者への影響 | Web UIの処理を常に優先 |
| 実装コスト | 最小限の機能から段階的に実装 |

## 9. 成功指標（提案）

1. **技術的指標**
   - API応答時間: 2秒以内
   - 処理成功率: 99%以上
   - システム稼働率: 99.9%

2. **利用指標**
   - APIでの月間処理ファイル数
   - エラー検出効率の向上率
   - 利用者からのフィードバック評価

## 10. まとめ

本提案は、貴サービスの「編集者支援」という理念を尊重しつつ、技術書制作の更なる効率化を実現するものです。最小限の実装から始め、段階的に機能を拡張することで、リスクを抑えながら価値を創出できると考えております。

特に、現在のPDF変換機能のみの特殊な利用状況を正式にサポートすることで、サーバー負荷の適正管理と利用者の作業効率向上を同時に実現できます。

## 11. 次のアクション

本提案にご興味をお持ちいただけましたら、以下のステップを提案いたします：

1. **技術的な実現可能性の検討**
2. **必要に応じた仕様の調整**
3. **概念実証の実施計画策定**

ご検討のほど、よろしくお願いいたします。

---

## 付録: 現在の利用例（参考）

```python
# 現在のSeleniumによる自動化の例
# これをAPIで置き換えることで、より効率的で安定した処理が可能に

import requests
import time

# API化後の理想的な実装
def convert_pdf_batch(word_files):
    job_ids = []
    
    # バッチでアップロード
    for file_path in word_files:
        with open(file_path, 'rb') as f:
            response = requests.post(
                'https://api.example.com/v1/pdf-convert',
                json={
                    'file': base64.b64encode(f.read()).decode(),
                    'filename': os.path.basename(file_path)
                },
                headers={'X-API-Key': 'your-api-key'}
            )
            job_ids.append(response.json()['job_id'])
    
    # 結果を効率的に収集
    results = []
    for job_id in job_ids:
        # ポーリングまたはWebhookで結果取得
        result = wait_for_completion(job_id)
        results.append(result)
    
    return results
```

*本文書は協議の進展に応じて適宜更新させていただきます。*