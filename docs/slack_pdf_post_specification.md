# Slack PDF投稿機能 仕様書

## 1. 概要

技術の泉シリーズ制作支援ツールに、生成済みPDFをSlackチャネルに投稿する機能を追加する。

### 1.1 目的
- 修正後のPDFファイルを該当するSlackチャネルに自動投稿
- 手動でのファイル選択とチャネル選択の手間を削減
- 投稿時のメッセージテンプレート提供による効率化

## 2. 機能要件

### 2.1 UI/UX設計

#### 2.1.1 メインウィンドウの変更
- 既存のN番号入力欄の横に「PDF投稿」ボタンを新設
- ボタンの配置：「N番号入力欄」→「変換実行」→「PDF投稿」の順

#### 2.1.2 処理フロー
1. **N番号入力と投稿ボタン押下**
   - ユーザーが既存のN番号入力欄にN番号を入力
   - 「PDF投稿」ボタンを押下

2. **チャネル検出ロジック**
   - N番号から下4桁を抽出（例：N01234 → 1234）
   - 抽出した4桁を含むSlackチャネルを検索
   - 検索パターン：`n{4桁}-*`（例：n1234-book-title）

3. **PDFファイル検出**
   - 既存のReVIEW変換ロジックを流用
   - N番号フォルダ配下の`out`フォルダを探索
   - PDFファイル（*.pdf）を検出
   - 複数ある場合は最新のものを選択

4. **確認ダイアログ表示**
   - モーダルダイアログで以下を表示：
     - PDFファイル名（読み取り専用）
     - 投稿先チャネル名（読み取り専用）
     - 投稿メッセージ（編集可能）
   - デフォルトメッセージ：「修正後のPDFです。ご確認よろしくおねがいします。」

5. **Slack投稿実行**
   - 「投稿」ボタン押下でSlack APIを使用して投稿
   - 投稿内容：メッセージ + PDFファイル
   - 投稿完了後、成功/失敗を通知

### 2.2 エラーハンドリング

#### 2.2.1 チャネルが見つからない場合
- エラーメッセージ：「N{4桁}に対応するチャネルが見つかりません」
- 手動でチャネル名を入力できるオプションを提供

#### 2.2.2 PDFファイルが見つからない場合
- エラーメッセージ：「PDFファイルが見つかりません。先に変換を実行してください」
- ファイル選択ダイアログを表示するオプション

#### 2.2.3 Botがチャネルに参加していない場合
- エラーメッセージと招待手順を表示
- 「@techzip_pdf_bot をチャネルに招待してください」

## 3. 技術仕様

### 3.1 実装クラス構成

```python
class SlackPDFPoster:
    """Slack PDF投稿機能のメインクラス"""
    
    def extract_channel_number(self, n_code: str) -> str:
        """N番号から下4桁を抽出"""
        
    def find_slack_channel(self, channel_number: str) -> Optional[str]:
        """4桁番号からSlackチャネルを検索"""
        
    def find_pdf_file(self, n_folder_path: str) -> Optional[str]:
        """N番号フォルダからPDFファイルを検出"""
        
    def show_confirmation_dialog(self, pdf_path: str, channel: str, message: str) -> Tuple[bool, str]:
        """確認ダイアログを表示"""
        
    def post_to_slack(self, pdf_path: str, channel: str, message: str) -> bool:
        """Slackに投稿"""
```

### 3.2 GUI実装

```python
class PDFPostDialog(QDialog):
    """PDF投稿確認ダイアログ"""
    
    def __init__(self, pdf_path: str, channel: str, default_message: str):
        # ファイル名表示（QLabel）
        # チャネル名表示（QLabel）
        # メッセージ編集（QTextEdit）
        # 投稿/キャンセルボタン
```

### 3.3 既存コードとの統合点

1. **MainWindow クラス**
   - 「PDF投稿」ボタンの追加
   - ボタンクリックイベントの処理

2. **RepoManager クラスの流用**
   - N番号からフォルダパスを解決するロジック
   - PDFファイル検索ロジック

3. **SlackIntegration クラスの使用**
   - チャネル検索機能
   - PDF投稿機能

## 4. デフォルト設定

### 4.1 メッセージテンプレート
```
修正後のPDFです。ご確認よろしくおねがいします。
```

### 4.2 PDFファイル検索パス
```
{N番号フォルダ}/out/*.pdf
```

### 4.3 チャネル名パターン
```
n{下4桁}-*
```

## 5. 将来の拡張性

### 5.1 設定可能項目
- メッセージテンプレートのカスタマイズ
- チャネル名の検索パターン変更
- 複数ファイル同時投稿

### 5.2 追加機能案
- 投稿履歴の記録
- スケジュール投稿
- 投稿前のPDFプレビュー

## 6. テスト計画

### 6.1 単体テスト
- N番号から4桁抽出のテスト
- チャネル検索ロジックのテスト
- PDFファイル検出のテスト

### 6.2 統合テスト
- n9999-bottest チャネルでの投稿テスト
- エラーケースのテスト
- UIの動作確認

## 7. リリース計画

### Phase 1（今回実装）
- 基本的な投稿機能
- 確認ダイアログ
- エラーハンドリング

### Phase 2（将来）
- 設定画面の追加
- 投稿履歴機能
- バッチ投稿対応