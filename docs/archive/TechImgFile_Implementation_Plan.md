# TechImgFile v0.5 実装計画書

**プロジェクト**: TECHZIP統合アプリ  
**作成日**: 2025-08-01  
**バージョン**: 0.5  
**推定工数**: 35-40時間（ST検証により大幅修正）  

## 1. 実装マイルストーン（ST検証対応版）

### 重要な変更点
- **従来見積もり20-25時間は40-60%不足**と判明
- **認証セキュリティ**と**Git操作安全性**が最重要リスク
- **段階的実装（MVP→フル機能）**が必須
- **Phase 0（リスク軽減設計）**を新規追加

### Phase 0: リスク軽減設計 (2-3時間) 【新規追加】
**目標**: 重要リスクの事前設計と軽減策の確立

#### 0.1 認証アーキテクチャ設計 (1時間)
- [ ] Windows Credential Manager統合設計
- [ ] OAuth2フロー設計（GitHub、Google）
- [ ] トークン管理セキュリティ設計
- [ ] 認証失敗時のフォールバック設計

#### 0.2 Git操作安全性設計 (1時間)
- [ ] dulwich採用可否検討と設計
- [ ] Git操作前確認フロー設計
- [ ] バックアップ戦略設計
- [ ] 操作履歴・監査ログ設計

#### 0.3 段階的展開設計 (0.5時間)
- [ ] MVP（ローカルのみ）モード設計
- [ ] フル機能モードとの境界線設計
- [ ] モード切り替えUI/UX設計

**成果物**:
```
docs/
├── authentication_architecture.md
├── git_safety_design.md
└── staged_deployment_plan.md
```

### Phase 1: プロジェクト基盤構築 (5-6時間) 【工数増加】
**目標**: 開発環境とプロジェクト構造の確立

#### 1.1 プロジェクト構造作成 (1時間)
- [ ] TechImgFileプロジェクトディレクトリ作成
- [ ] 必要なサブディレクトリ構築
- [ ] __init__.py ファイル配置
- [ ] requirements.txt 作成

#### 1.2 基本設定システム (1.5時間)
- [ ] ConfigManager クラス実装
- [ ] デフォルト設定ファイル (settings.json) 作成
- [ ] 環境変数対応
- [ ] 設定バリデーション機能

#### 1.3 ログシステム (1時間)
- [ ] ログ設定実装  
- [ ] ログローテーション設定
- [ ] 構造化ログ出力対応
- [ ] デバッグモード対応

#### 1.4 認証基盤実装 (1時間) 【新規追加】
- [ ] Windows Credential Manager統合
- [ ] 基本認証クラス実装
- [ ] 認証状態管理
- [ ] セキュリティ設定読み込み

#### 1.5 基本バリデーション (0.5時間)
- [ ] N番号バリデーション関数
- [ ] パス検証ユーティリティ
- [ ] Git URL検証機能
- [ ] 認証トークン検証

**成果物**:
```
app/
├── config/
│   └── settings.json
├── utils/
│   ├── config.py
│   ├── logger.py
│   └── validators.py
├── main.py
└── requirements.txt
```

### Phase 2: コア機能実装 (10-12時間) 【工数増加】
**目標**: N番号処理とGoogle Sheets連携の実装

#### 2.1 N番号処理エンジン (2時間)
- [ ] NCodeProcessor クラス実装
- [ ] N番号フォーマット検証
- [ ] キャッシュ機能実装
- [ ] エラーハンドリング

#### 2.2 Google Sheets連携（セキュリティ強化） (3時間) 【工数増加】
- [ ] GoogleSheetsClient クラス実装
- [ ] セキュアなサービスアカウント認証
- [ ] 認証トークン安全管理
- [ ] シート検索機能
- [ ] レート制限対応
- [ ] エラーリトライ機能
- [ ] 認証失敗時の適切な処理

#### 2.3 画像処理エンジン移植 (3時間)
- [ ] ImageProcessor クラス実装
- [ ] 既存techbook27.py機能移植
  - [ ] プロファイル除去
  - [ ] グレースケール変換
  - [ ] リサイズ機能
  - [ ] PNG→JPG変換
- [ ] バックアップ機能
- [ ] 進捗通知対応

#### 2.4 認証管理ダイアログ (1.5時間) 【新規追加】
- [ ] 認証管理UI実装
- [ ] GitHub認証フロー
- [ ] Google認証設定
- [ ] セキュリティ設定UI
- [ ] 認証テスト機能

#### 2.5 基本ワークフロー (1時間) 【工数増加】
- [ ] WorkflowManager 基本構造
- [ ] MVP/フル機能モード対応
- [ ] 認証状態チェック統合
- [ ] シングルスレッド版ワークフロー
- [ ] エラー収集機能

**成果物**:
```
core/
├── n_code_processor.py
├── image_processor.py
└── workflow_manager.py
integrations/
└── google_sheets.py
```

**テストマイルストーン**: 
- N番号 → リポジトリ名取得 → ローカル画像処理の基本フローが動作

### Phase 3: Git連携機能（安全性強化） (6-8時間) 【大幅工数増加】
**目標**: GitHub連携とリポジトリ管理機能の実装

#### 3.1 安全なGit操作基盤 (2.5時間) 【工数増加】
- [ ] RepositoryManager クラス実装
- [ ] dulwich採用検討・実装
- [ ] Git操作前バックアップ機能
- [ ] 操作履歴記録機能
- [ ] ローカルリポジトリ検索
- [ ] 安全なGitコマンドラッパー
- [ ] 画像フォルダ自動検出

#### 3.2 セキュアなGitHub Clone機能 (2.5時間) 【工数増加】
- [ ] GitHubClient クラス実装
- [ ] セキュアなClone機能実装
- [ ] 複数認証方式対応（Token、OAuth2）
- [ ] プライベートリポジトリ対応
- [ ] Clone前の安全性確認
- [ ] Clone進捗とキャンセル対応

#### 3.3 安全なCommit & Push機能 (2時間) 【工数増加】
- [ ] 変更検出機能
- [ ] Git操作前確認ダイアログ
- [ ] バックアップ付きコミット機能
- [ ] 安全なプッシュ機能
- [ ] コンフリクト検出と回避
- [ ] 操作ロールバック機能

#### 3.4 Git監査・ログ機能 (1時間) 【新規追加】
- [ ] Git操作監査ログ
- [ ] 操作履歴表示
- [ ] セキュリティイベント記録
- [ ] ロールバック支援機能

**成果物**:
```
core/
└── repository_manager.py
integrations/
└── github_client.py
```

**テストマイルストーン**: 
- N番号 → Clone → 画像処理 → Commit & Push の完全フローが動作

### Phase 4: UI実装（モード対応） (6-7時間) 【工数増加】
**目標**: Qt6ベースのユーザーインターフェース実装

#### 4.1 メインウィンドウ（モード対応） (3時間) 【工数増加】
- [ ] MainWindow クラス実装
- [ ] MVP/フル機能モード切り替えUI
- [ ] 認証状態表示
- [ ] レイアウト構築
- [ ] N番号入力部分
- [ ] フォルダ処理部分
- [ ] 処理オプション設定
- [ ] ログ表示エリア

#### 4.2 進捗表示とダイアログ（安全性対応） (2時間) 【工数増加】
- [ ] ProgressDialog 実装
- [ ] 処理キャンセル機能（Git操作対応）
- [ ] 進捗バー更新
- [ ] 認証管理ダイアログ実装
- [ ] Git安全性確認ダイアログ
- [ ] SettingsDialog 基本構造

#### 4.3 非同期処理統合 (1時間)
- [ ] WorkflowThread 実装
- [ ] シグナル・スロット接続
- [ ] UI更新処理
- [ ] エラー表示処理

#### 4.4 UI統合テスト (1時間)
- [ ] 各機能のUIテスト
- [ ] レスポンシブ対応確認
- [ ] エラーケースのUI確認

**成果物**:
```
ui/
├── main_window.py
├── progress_dialog.py
└── settings_dialog.py
core/
└── workflow_thread.py
```

**テストマイルストーン**: 
- GUI から完全ワークフローが実行可能

### Phase 5: 統合・最適化（セキュリティ対応） (4-6時間) 【工数増加】
**目標**: システム統合とパフォーマンス最適化

#### 5.1 エラーハンドリング強化（セキュリティ対応） (1.5時間) 【工数増加】
- [ ] 統合エラーハンドラー実装
- [ ] セキュリティエラーの適切な処理
- [ ] 認証エラーのフォールバック
- [ ] Git操作エラーの安全な回復
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] 復旧可能エラーの処理
- [ ] ログとエラー表示の統合

#### 5.2 設定画面完成（セキュリティ強化） (2時間) 【工数増加】
- [ ] 完全な設定ダイアログ実装
- [ ] セキュリティ設定部分
- [ ] Git安全性設定部分
- [ ] 認証設定統合
- [ ] Google Sheets設定部分
- [ ] 画像処理オプション設定
- [ ] 設定検証とテスト機能
- [ ] セキュリティテスト実行

#### 5.3 セキュリティテスト・最適化 (1.5時間) 【工数増加】
- [ ] セキュリティテストスイート実行
- [ ] 認証フローテスト
- [ ] Git操作安全性テスト
- [ ] 大量ファイル処理の最適化
- [ ] メモリ使用量の最適化
- [ ] UI応答性の改善

#### 5.4 MVP/フル機能統合テスト (1時間) 【新規追加】
- [ ] モード切り替えテスト
- [ ] MVP機能完全性テスト
- [ ] フル機能統合テスト
- [ ] セキュリティ境界テスト

**成果物**:
```
core/
└── error_handler.py
ui/
└── settings_dialog.py (完成版)
```

### Phase 6: EXE化とTECHGATE統合 (3-4時間) 【工数増加】
**目標**: Windows EXE化とTECHGATE統合

#### 6.1 EXE化準備（セキュリティ対応） (1.5時間) 【工数増加】
- [ ] PyInstaller設定ファイル作成
- [ ] セキュリティライブラリ依存関係整理
- [ ] 認証関連リソース準備
- [ ] 設定ファイルテンプレート準備
- [ ] リソースファイル準備
- [ ] アイコン設定

#### 6.2 ビルドスクリプト作成（テスト強化） (1.5時間) 【工数増加】
- [ ] TechImgFile.build.ps1 作成
- [ ] バージョン管理機能
- [ ] 前バージョン保持機能
- [ ] セキュリティテスト自動実行
- [ ] EXE動作テスト
- [ ] 認証機能テスト

#### 6.3 TECHGATE統合 (1時間)
- [ ] TechGate.py に検出パターン追加
- [ ] 起動パラメータ対応
- [ ] バージョン情報連携

**成果物**:
```
TechImgFile.build.ps1
TechImgFile.spec
dist/TechImgFile.0.5.exe
```

**最終テストマイルストーン**: 
- TECHGATEからTechImgFile.0.5.exeが起動可能
- 全機能がEXE版で正常動作

## 2. 詳細実装スケジュール（修正版）

### Week 1: リスク軽減と基盤構築 (12-18時間)
**日程**: 実装開始〜7日間

| 日 | 作業内容 | 時間 | 累計 |
|----|---------|------|------|  
| 1日目 | Phase 0: リスク軽減設計 + Phase 1開始 | 5-6h | 5-6h |
| 2日目 | Phase 1完了 + Phase 2開始（N番号・認証） | 6-7h | 11-13h |
| 3日目 | Phase 2続行（Sheets連携・画像処理） | 5-6h | 16-19h |

**中間テスト**: N番号からローカル画像処理までの基本フロー

### Week 2: Git連携とUI（安全性重視） (12-16時間)
**日程**: 8日目〜14日間

| 日 | 作業内容 | 時間 | 累計 |
|----|---------|------|------|
| 4日目 | Phase 2完了 + Phase 3開始（Git安全性） | 6-7h | 22-26h |
| 5日目 | Phase 3続行（Clone・Commit安全化） | 5-6h | 27-32h |
| 6日目 | Phase 4: UI実装（モード対応） | 6-7h | 33-39h |

**中間テスト**: GUI経由での完全ワークフロー

### Week 3: 統合・セキュリティテスト・EXE化 (7-10時間)
**日程**: 15日目〜21日間

| 日 | 作業内容 | 時間 | 累計 |
|----|---------|------|------|
| 7日目 | Phase 5: 統合・セキュリティ最適化 | 4-6h | 37-45h |
| 8日目 | Phase 6: EXE化とTECHGATE統合 | 3-4h | 40-49h |

**最終テスト**: 全機能の結合テスト、セキュリティテスト、EXE動作確認

**総工数**: 35-40時間（従来見積もり20-25時間から大幅増加）

## 3. リスク管理とバックアップ計画

### 3.1 技術リスク

#### 高リスク
- **Google Sheets API制限**: 1日100リクエスト制限
  - **対策**: キャッシュ機能強化、バッチ処理の実装
  - **バックアップ**: ローカルCSVファイル対応

- **GitHub認証問題**: Tokenの有効期限・権限不足
  - **対策**: 複数認証方式対応（Token、SSH）
  - **バックアップ**: 手動Clone指示機能

#### 中リスク  
- **大容量リポジトリのClone**: メモリ不足、タイムアウト
  - **対策**: 進捗表示、部分Clone対応
  - **バックアップ**: Manual指定機能

- **Qt6互換性問題**: ライブラリ依存関係
  - **対策**: 段階的移行、Qt5バックアップ
  - **バックアップ**: CustomTkinter版維持

### 3.2 スケジュールリスク

#### 遅延要因
- **Google Sheets API学習コスト**: +2時間
- **Git操作の複雑化**: +2時間  
- **UI調整作業**: +3時間
- **EXE化トラブル**: +2時間

#### 対策
- **優先度付き実装**: 最小機能→拡張機能の順序
- **早期プロトタイプ**: 各Phaseでの動作確認
- **時間ボックス**: 各作業に最大時間を設定

### 3.3 品質保証

#### テスト戦略
```python
# 単体テスト (pytest)
tests/unit/
├── test_n_code_processor.py      # N番号処理
├── test_repository_manager.py    # Git操作  
├── test_image_processor.py       # 画像処理
└── test_config_manager.py        # 設定管理

# 統合テスト
tests/integration/
├── test_workflow_integration.py  # 完全フロー
└── test_ui_integration.py        # UI操作

# EXEテスト
tests/exe/
└── test_exe_functionality.py     # EXE版機能確認
```

#### コードレビューポイント
- **エラーハンドリング**: すべての外部依存でtry-catch
- **リソース管理**: ファイル・ネットワーク接続の適切なクリーンアップ
- **ログ出力**: 十分なデバッグ情報の記録
- **設定検証**: 不正な設定値での安全な動作

## 4. 外部依存関係

### 4.1 必要なライブラリ
```txt
# requirements.txt
PyQt6>=6.4.0
Pillow>=9.0.0
requests>=2.28.0
google-api-python-client>=2.50.0
google-auth-httplib2>=0.1.0
google-auth-oauthlib>=0.5.0
gitpython>=3.1.0
pytest>=7.0.0
pyinstaller>=5.0.0
```

### 4.2 外部サービス依存
- **Google Sheets API**: N番号→リポジトリ名マッピング
- **GitHub API**: リポジトリ存在確認・Clone
- **Git**: ローカルリポジトリ操作

### 4.3 設定ファイル依存
- **Google認証**: `config/credentials.json`
- **GitHub Token**: 環境変数またはsettings.json
- **リポジトリパス**: 設定可能なベースパス

## 5. デプロイメント戦略

### 5.1 開発環境
```bash
# 開発環境セットアップ
cd /mnt/c/Users/tky99/DEV/technical-fountain-series-support-tool
mkdir app
cd app
python -m venv venv
source venv/bin/activate  # WSL
# venv\Scripts\activate   # Windows
pip install -r requirements.txt
```

### 5.2 ビルド環境
```powershell
# Windows ビルド環境
cd C:\Users\tky99\DEV\technical-fountain-series-support-tool\app
python -m venv venv_build
.\venv_build\Scripts\Activate.ps1
pip install -r requirements.txt
.\TechImgFile.build.ps1
```

### 5.3 配布準備
- **EXEファイル**: `dist/TechImgFile.0.5.exe`
- **設定テンプレート**: `config/settings_template.json`
- **README**: インストール・設定手順
- **認証設定ガイド**: Google Sheets・GitHub設定方法

## 6. 成功基準

### 6.1 機能要件クリア基準
- [ ] N番号入力→リポジトリ名取得 (100%成功率)
- [ ] ローカルリポジトリ検索→存在時の利用 (100%動作)
- [ ] GitHub Clone→新規リポジトリ取得 (認証正常時100%動作)
- [ ] 画像処理→既存techbook27.py同等機能 (品質維持)
- [ ] Commit & Push→Git操作 (エラー時の適切な表示)

### 6.2 非機能要件クリア基準
- [ ] UI応答性→メイン処理の非同期実行 (UIフリーズなし)
- [ ] エラーハンドリング→すべてのエラーで適切なメッセージ表示
- [ ] 設定管理→GUI経由での全設定変更可能
- [ ] ログ記録→デバッグに十分な情報出力

### 6.3 統合要件クリア基準
- [ ] EXE化→依存関係込みで単一実行ファイル作成
- [ ] TECHGATE統合→バージョン検出・起動・表示
- [ ] Windows EXE標準→命名規則・ビルドスクリプト準拠

このマイルストーンに従って実装することで、効率的かつ確実にTechImgFile v0.5を完成させることができます。