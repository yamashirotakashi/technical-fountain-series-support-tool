# TechZip リファクタリングロードマップ

最終更新: 2025-01-27

## 📋 概要

このドキュメントは、TechZipプロジェクトの実装過程で遭遇した問題から学んだ教訓を基に、今後のリファクタリング方針をまとめたものです。

## 🔍 現状の課題

### 1. 環境依存性の管理不足
- **問題**: EXE環境での設定継承失敗、開発/本番環境の差異
- **影響**: デプロイ時の予期しない動作、デバッグの困難さ

### 2. 時間的複雑性の過小評価
- **問題**: タイムゾーン処理の不一致、非同期処理の時刻管理
- **影響**: メール誤検出、処理タイミングの不整合

### 3. セキュリティと利便性のトレードオフ
- **問題**: APIトークンのハードコード、環境変数管理の不一致
- **影響**: GitHubプッシュ拒否、セキュリティリスク

### 4. 暗黙知の増加
- **問題**: ドキュメント化されない仕様変更、スキーマの暗黙的変更
- **影響**: 保守性の低下、新規参加者の学習コスト増大

## 🎯 リファクタリング方針

### Phase 1: アーキテクチャの再設計（2025年Q1）

#### 1.1 ヘキサゴナルアーキテクチャの採用
```
┌─────────────────────────────────────────────────┐
│                  Presentation Layer              │
│                  (GUI / CLI)                     │
├─────────────────────────────────────────────────┤
│                  Application Layer               │
│              (Use Cases / Services)              │
├─────────────────────────────────────────────────┤
│                   Domain Layer                   │
│            (Business Logic / Entities)           │
├─────────────────────────────────────────────────┤
│                 Infrastructure Layer             │
│        (External Services / Repositories)        │
└─────────────────────────────────────────────────┘
```

**目的**: 外部サービス（Gmail、Slack、GitHub）への依存を分離

#### 1.2 設定管理の一元化
- 12-Factor App原則に従った環境変数管理
- 設定のバリデーションとデフォルト値の明確化
- 開発/ステージング/本番で同一コードベース

### Phase 2: 時間管理の改善（2025年Q1）

#### 2.1 UTC統一ポリシー
```python
# すべての内部処理はUTCで統一
from datetime import datetime, timezone

class TimeManager:
    @staticmethod
    def now() -> datetime:
        """常にUTCで現在時刻を返す"""
        return datetime.now(timezone.utc)
    
    @staticmethod
    def to_jst(dt: datetime) -> datetime:
        """表示用にJSTに変換（表示層でのみ使用）"""
        from zoneinfo import ZoneInfo
        return dt.astimezone(ZoneInfo('Asia/Tokyo'))
```

#### 2.2 非同期処理の明確化
- イベント駆動アーキテクチャの採用
- 状態遷移の明示的な定義
- タイムアウトとリトライの標準化

### Phase 3: 品質保証の強化（2025年Q2）

#### 3.1 自動テストの充実
```yaml
# CI/CDパイプライン構成
name: TechZip CI/CD
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Unit Tests
        run: pytest tests/unit
      - name: Run Integration Tests
        run: pytest tests/integration
      - name: Run E2E Tests
        run: pytest tests/e2e
```

#### 3.2 コードレビューの必須化
- PR時の自動チェック（linting、type checking）
- 最低1名のレビュー必須
- セキュリティスキャンの自動実行

### Phase 4: 知識管理の体系化（2025年Q2）

#### 4.1 ADR（Architecture Decision Records）の導入
```markdown
# ADR-001: ヘキサゴナルアーキテクチャの採用

## ステータス
採用

## コンテキスト
外部サービスへの依存が高く、変更の影響が広範囲に及ぶ

## 決定
ヘキサゴナルアーキテクチャを採用し、ビジネスロジックを保護する

## 結果
- 外部サービスの変更に対する耐性向上
- テスタビリティの改善
- 責任の明確化
```

#### 4.2 ドキュメントの自動生成
- コードからのAPI仕様書生成
- データフロー図の自動更新
- 依存関係グラフの可視化

## 📊 実装優先順位

### 高優先度（即座に実施）
1. ✅ タイムゾーン処理の修正（完了）
2. 🔄 環境変数管理の統一化
3. 🔄 セキュリティトークンの環境変数化

### 中優先度（1-2ヶ月以内）
1. ヘキサゴナルアーキテクチャへの段階的移行
2. 単体テストの追加（カバレッジ80%目標）
3. CI/CDパイプラインの構築

### 低優先度（3ヶ月以内）
1. ADRの導入と既存決定の文書化
2. E2Eテストの自動化
3. パフォーマンスモニタリングの実装

## 🚀 実装アプローチ

### 段階的リファクタリング
1. **既存機能を維持しながら**新アーキテクチャを並行実装
2. **Feature Flagを使用**して段階的に切り替え
3. **十分なテスト後**に旧実装を削除

### チーム開発の考慮
- ペアプログラミング/モブプログラミングの活用
- 週次の技術共有会
- リファクタリング進捗の可視化

## 📈 成功指標

### 定量的指標
- コードカバレッジ: 80%以上
- デプロイ失敗率: 5%以下
- 平均修正時間: 2時間以内
- セキュリティ脆弱性: 0件

### 定性的指標
- 新機能追加の容易さ
- デバッグの効率性
- チームメンバーの理解度
- 外部サービス変更への対応速度

## 🔄 継続的改善

### 振り返りサイクル
- 週次: 実装の振り返り
- 月次: アーキテクチャレビュー
- 四半期: 方針の見直し

### フィードバックループ
- ユーザーからのフィードバック収集
- エラー監視とアラート
- パフォーマンスメトリクスの分析

## 📝 まとめ

TechZipプロジェクトのリファクタリングは、単なるコード改善ではなく、**持続可能な開発プロセスの確立**を目指します。問題を「成長痛」と捉え、継続的に改善していくことで、より堅牢で保守性の高いシステムを構築します。

---

*このドキュメントは生きているドキュメントであり、プロジェクトの進化に合わせて更新されます。*