# コードブロックはみ出し検出システム 仕様書 v5
## 段階的実装アプローチ版

### 文書情報
- **バージョン**: 5.0.0
- **作成日**: 2025-01-28
- **対象システム**: 技術の泉シリーズ制作支援ツール 拡張機能
- **実装方式**: 3段階の段階的実装

---

## 1. 概要

### 1.1 目的
技術の泉シリーズのNextPublishing形式PDFにおいて、コードブロック内のテキストが右端からはみ出す問題を自動検出する。

### 1.2 段階的実装計画
- **Stage 1**: 灰色背景コードブロックの検出（1日）
- **Stage 2**: 罫線検出の技術検証（0.5日）
- **Stage 3**: 罫線囲みコードブロックの実装（1-2日）

---

## 2. Stage 1: 基本実装（1日）

### 2.1 スコープ
- **対象**: 灰色背景（RGB: 0.9, 0.9, 0.9）のコードブロックのみ
- **検出精度**: 0.1pt以上のはみ出し
- **出力**: ページ番号のリスト（ユーザー要求準拠）

### 2.2 技術仕様
```python
# 必要ライブラリ
pdfplumber>=0.9.0    # テキスト位置情報
PyMuPDF>=1.23.0      # 図形の塗りつぶし色情報
```

### 2.3 出力形式（シンプル版）
```
=== コードブロックはみ出し検出結果 ===
ファイル: sample.pdf
検出日時: 2025-01-28 10:30:45

はみ出しが検出されたページ:
10, 20, 48

検出数: 3ページ
処理時間: 12.3秒
```

### 2.4 実装手順
1. **環境準備**（30分）
   - ライブラリインストール
   - 基本構造の作成

2. **検出ロジック**（3時間）
   - PyMuPDFで灰色矩形検出
   - pdfplumberでテキスト解析
   - はみ出し計算

3. **テストと調整**（1.5時間）
   - sample.pdfでの動作確認
   - パフォーマンス最適化

---

## 3. Stage 2: 技術検証（0.5日）

### 3.1 検証項目
- sample2.pdf（60ページ）の罫線構造解析
- コードブロックと表の区別方法の確立
- 検出アルゴリズムの実現可能性評価

### 3.2 検証成果物
- 技術検証レポート
- 実装可能性の判定
- Stage 3の詳細見積もり

---

## 4. Stage 3: 罫線対応（条件付き実装）

### 4.1 実装条件
Stage 2の検証で以下が確認された場合のみ実装：
- 技術的に実現可能
- 合理的な期間（2日以内）で完成可能
- 誤検出率が許容範囲内

### 4.2 想定される課題と対策
- **課題**: 表との区別
- **対策**: コード特有のパターン（インデント、キーワード）を併用

### 4.3 拡張出力形式（オプション）
```
=== コードブロックはみ出し検出結果 ===
ファイル: sample2.pdf
検出日時: 2025-01-28 14:30:45

はみ出しが検出されたページ:
[灰色背景] 10, 20, 48
[罫線囲み] 60, 75

検出数: 5ページ（灰色: 3, 罫線: 2）
処理時間: 18.5秒
```

---

## 5. リスク管理

### 5.1 Stage 1のリスク（低）
- 既存技術の組み合わせで実現可能
- sample.pdfで動作確認済み
- 1日での完成は高確率で可能

### 5.2 Stage 3のリスク（高）
- 罫線検出の複雑性
- 表との区別の困難さ
- 実装期間の不確実性

### 5.3 リスク軽減策
- Stage 1の確実な完成を最優先
- Stage 2での十分な検証
- Stage 3は検証結果次第で中止も選択肢

---

## 6. 成功基準

### 6.1 Stage 1完了条件
- [ ] sample.pdfの48ページのはみ出しを検出
- [ ] ページ番号のみの出力
- [ ] 100ページを60秒以内で処理
- [ ] エラー時もクラッシュしない

### 6.2 プロジェクト全体の成功基準
- [ ] 最低限Stage 1が完成（必須）
- [ ] Stage 2の検証完了（必須）
- [ ] Stage 3の実装（オプション）

---

## 7. 実装優先順位

### 必須機能（Stage 1）
1. 灰色背景コードブロックの検出
2. シンプルなページ番号出力
3. 基本的なエラーハンドリング

### 追加機能（Stage 3、条件付き）
1. 罫線囲みコードブロックの検出
2. タイプ別の出力（要検討）
3. 詳細なレポート機能

---

## 付録: 判断基準

### コードブロックの判定基準（Stage 3用）
1. **構造的特徴**
   - 複数行にわたる
   - 一定のインデント
   - プログラミング言語のキーワード

2. **視覚的特徴**
   - 等幅フォント（多くの場合）
   - 行間が一定
   - 左マージンが揃っている

3. **内容的特徴**
   - コメント記号（//, #, /* */）
   - 括弧の対応（{}, [], ()）
   - セミコロンや演算子

これらの特徴を組み合わせて、表との区別を行う。