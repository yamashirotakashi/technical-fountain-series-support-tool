# コードブロックはみ出し検出システム 仕様書
## 仕様書駆動開発（SDD）用

### 文書情報
- **バージョン**: 1.0.0
- **作成日**: 2025-01-28
- **対象システム**: 技術の泉シリーズ制作支援ツール 拡張機能
- **開発フェーズ**: Phase 1（独立アプリケーション）→ Phase 2（統合）

---

## 1. 概要

### 1.1 目的
技術の泉シリーズの組版PDFにおいて、コードブロック内のテキストが右端からはみ出す問題を自動検出する。1ピクセルでもはみ出せば製品として重大な欠陥となるため、高精度な検出が必要。

### 1.2 背景
- NextPublishing形式で生成されたPDFファイルが対象
- コードブロックは灰色背景（RGB: 0.9, 0.9, 0.9）で表示
- 主に100-200ページのPDFを処理
- 編集者が手動で確認している作業を自動化

### 1.3 スコープ
**Phase 1で実装する機能**：
- Nコード入力によるPDF指定
- PDFからのコードブロック検出
- はみ出し幅の測定（0.1pt精度）
- 検出結果のレポート生成

**Phase 1で実装しない機能**：
- 自動修正機能
- GUI統合（既存システムへの組み込み）
- クラウド連携
- 機械学習による検出

---

## 2. 機能要件

### 2.1 入力仕様
- **入力形式**: Nコード（例: N02279）
- **PDF取得元**: `{Nコードフォルダ}/out/` ディレクトリ
- **対応PDF**: NextPublishing形式、40-400ページ（主に100-200ページ）

### 2.2 検出機能

#### 2.2.1 コードブロック識別
- 背景色による識別: RGB(0.9, 0.9, 0.9) ± 0.02
- 矩形形状の抽出
- 等幅フォント（Consolas, Courier等）の想定

#### 2.2.2 はみ出し検出
- **検出精度**: 0.1pt単位
- **検出方法**: テキストベース解析（Phase 1必須）
- **測定内容**: 各行の最右端文字位置とブロック境界の差

#### 2.2.3 重要度分類
```
- 微小（micro）: 0.1-1.0pt
- 軽微（minor）: 1.0-5.0pt  
- 中程度（moderate）: 5.0-20.0pt
- 重大（major）: 20.0-50.0pt
- 致命的（critical）: 50.0pt以上
```

### 2.3 出力仕様

#### 2.3.1 レポート形式
- Markdownファイル出力
- ページ番号、行番号、はみ出し幅を記載
- 重要度別のサマリー表示
- 該当箇所のテキストプレビュー（最大100文字）

#### 2.3.2 レポート構成
```markdown
# コードブロックはみ出し検出レポート

## サマリー
- ファイル: [ファイル名]
- 総ページ数: [数値]
- 検出時間: [秒]
- 検出されたはみ出し: [件数]

## 重要度別分布
[表形式で表示]

## 詳細
[ページごとの検出結果]
```

---

## 3. 非機能要件

### 3.1 性能要件
- **処理速度**: 100ページを30秒以内
- **メモリ使用量**: 最大2GB
- **並列処理**: 最大4プロセス

### 3.2 品質要件
- **検出精度**: 0.1pt単位での正確な測定
- **エラー耐性**: 部分的な解析失敗でも処理継続
- **ログ出力**: 処理状況の詳細ログ

### 3.3 制約事項
- Python 3.8以上
- 外部ライブラリは最小限に抑える
- 既存システムに影響を与えない独立構造

---

## 4. システム構成

### 4.1 ディレクトリ構造
```
CodeBlockOverFlowDisposal/
├── overflow_detector/
│   ├── __init__.py
│   ├── main.py              # エントリーポイント
│   ├── core/
│   │   ├── detector.py      # 検出ロジック
│   │   └── analyzer.py      # テキスト解析
│   ├── models/
│   │   └── detection.py     # データモデル
│   ├── utils/
│   │   └── pdf_utils.py     # PDF操作
│   └── reporting/
│       └── markdown.py      # レポート生成
├── config/
│   └── default.yaml         # 設定ファイル
├── tests/
│   └── test_detector.py     # テストコード
└── requirements.txt         # 依存関係
```

### 4.2 主要コンポーネント

#### 4.2.1 OverflowDetector（メインクラス）
- PDF読み込みと解析の制御
- エラーハンドリング
- 進捗管理

#### 4.2.2 TextAnalyzer
- pdfplumberを使用したテキスト抽出
- 文字位置情報の解析
- はみ出し幅の計算

#### 4.2.3 ReportGenerator
- Markdown形式でのレポート生成
- 重要度別の集計
- 視覚的に分かりやすい出力

---

## 5. インターフェース仕様

### 5.1 コマンドライン（Phase 1）
```bash
# 基本実行
python -m overflow_detector N02279

# オプション付き実行
python -m overflow_detector N02279 --output report.md --threshold 5.0
```

### 5.2 Python API
```python
from overflow_detector import OverflowDetector

detector = OverflowDetector()
result = detector.detect_from_ncode("N02279")
detector.generate_report(result, "report.md")
```

---

## 6. エラー処理

### 6.1 エラー分類
- **E1001**: PDFファイルが見つからない → 空の結果を返す
- **E1002**: PDF解析エラー → 該当ページをスキップ
- **E1003**: メモリ不足 → 処理を簡略化
- **E1004**: タイムアウト → 部分的な結果を返す

### 6.2 リカバリー戦略
- エラー時も可能な限り処理を継続
- 部分的な結果でもレポート生成
- エラー内容をログに記録

---

## 7. テスト要件

### 7.1 テストケース
1. 正常なコードブロック（はみ出しなし）
2. 微小なはみ出し（0.5pt）
3. 中程度のはみ出し（10pt）
4. 致命的なはみ出し（50pt以上）
5. 日本語を含むコード
6. 100ページのPDF処理

### 7.2 性能テスト
- 処理時間の測定
- メモリ使用量の監視
- 大容量PDF（400ページ）での動作確認

---

## 8. Phase 2 統合計画

### 8.1 統合ポイント
- 既存の編集支援システムのメニューに追加
- 処理完了後の自動通知
- 結果の履歴管理

### 8.2 統合時の変更点
- GUIインターフェースの追加
- 設定の一元管理
- バッチ処理対応

### 8.3 移行作業
1. 独立モジュールとしてのテスト完了
2. 統合アダプターの作成
3. 既存システムへの組み込み
4. 統合テストの実施

---

## 9. 実装優先順位

### 9.1 必須機能（Phase 1初期）
1. PDFからのコードブロック検出
2. テキストベースのはみ出し検出
3. 基本的なレポート生成
4. エラーハンドリング

### 9.2 追加機能（Phase 1後期）
1. 詳細なレポート機能
2. 設定ファイル対応
3. ログ機能の充実

### 9.3 将来機能（Phase 2以降）
1. 視覚的検証の追加
2. キャッシュ機能
3. 並列処理の最適化
4. GUI統合

---

## 10. 制約と前提条件

### 10.1 技術的前提
- NextPublishing形式のPDFであること
- コードブロックが灰色背景であること
- 等幅フォントが使用されていること

### 10.2 運用上の前提
- 編集者が結果を目視確認すること
- 自動修正は行わないこと
- 1ファイルずつ処理すること

### 10.3 開発上の制約
- 既存システムのコードを変更しない
- 外部ライブラリは最小限に留める
- メンテナンス性を重視した設計

---

## 付録A: 用語定義

- **Nコード**: なろう小説家になろうの作品識別コード
- **コードブロック**: プログラムコードを表示する灰色背景の領域
- **はみ出し**: テキストがコードブロックの右端境界を超えること
- **NextPublishing**: 技術書制作用の組版システム

---

## 付録B: 参考資料

- サンプルPDF: `sample.pdf`（48ページにはみ出しサンプル）
- はみ出しサンプル: `sampleOverflow.pdf`
- 既存システムドキュメント: 編集支援システムTECHZIP仕様書