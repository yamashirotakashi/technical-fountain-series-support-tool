# コードブロックはみ出し検出システム 実装計画書

## 1. 実装概要

### 1.1 実装アプローチ
- **Phase 1**: 独立したコマンドラインツールとして実装（1日）
- **Phase 2**: 既存の編集支援システムTECHZIPへの統合（将来）

### 1.2 技術選定の根拠
- **pdfplumber**: テキスト位置情報の正確な取得に優れる
- **PyMuPDF (fitz)**: 図形の塗りつぶし色情報の取得が可能
- 両ライブラリの併用により、確実な検出を実現

---

## 2. Phase 1 実装詳細

### 2.1 実装ステップ

#### Step 1: 環境準備（15分）
```bash
# 追加ライブラリのインストール
pip install pdfplumber PyMuPDF

# または requirements_addon.txt を作成
echo "pdfplumber>=0.9.0" > requirements_addon.txt
echo "PyMuPDF>=1.23.0" >> requirements_addon.txt
pip install -r requirements_addon.txt
```

#### Step 2: 基本構造の実装（30分）
- ファイル: `overflow_detector.py`
- クラス構造の実装
- コマンドライン引数の処理
- エラーハンドリングの基盤

#### Step 3: 検出ロジックの実装（2時間）
1. PyMuPDFによる灰色矩形検出
2. pdfplumberによるテキスト解析
3. はみ出し判定ロジック
4. 結果の収集と整理

#### Step 4: レポート生成（30分）
- シンプルなテキスト形式
- ページ番号とはみ出し幅のみ表示
- 重要度による分類（軽微/重大/致命的）

#### Step 5: テストと調整（1時間）
- sample.pdf（48ページにはみ出し）での検証
- 処理速度の確認
- エッジケースの対応

### 2.2 出力形式（修正版）

```
=== コードブロックはみ出し検出レポート ===
ファイル: sample.pdf
検出日時: 2025-01-28 10:30:45
総ページ数: 48

■ 検出されたはみ出し: 3件

ページ 10: 5.5pt はみ出し
ページ 20: 15.3pt はみ出し（要修正）
ページ 48: 52.1pt はみ出し（致命的）

■ サマリー
  - 軽微（<20pt）: 2件
  - 重大（20-50pt）: 0件
  - 致命的（>50pt）: 1件

処理時間: 12.3秒
```

---

## 3. コード構造

### 3.1 メインクラス
```python
class CodeBlockOverflowDetector:
    """シンプルな実装に焦点を当てたクラス"""
    
    def detect_file(self, pdf_path: Path) -> List[Dict]:
        """メイン処理"""
        
    def _find_code_blocks(self, doc_fitz) -> Dict[int, List[Rect]]:
        """各ページの灰色矩形を検出"""
        
    def _check_overflow(self, pdf_plumber, page_num: int, rect: Rect) -> Optional[Dict]:
        """特定の矩形内のはみ出しをチェック"""
        
    def generate_report(self, results: List[Dict]) -> str:
        """レポート生成"""
```

### 3.2 エラーハンドリング
- ファイルが見つからない → 明確なエラーメッセージ
- PDF解析エラー → 該当ページをスキップして継続
- 予期しないエラー → スタックトレースをログに記録

---

## 4. Phase 2 統合計画（概要）

### 4.1 統合ポイント
- 既存の`core/`ディレクトリに移動
- PyQt6 GUIへのメニュー追加
- 非同期処理でUIをブロックしない

### 4.2 必要な変更
1. モジュール化（クラスの分離）
2. プログレスバー対応
3. GUI用の結果表示ウィジェット

---

## 5. 品質保証

### 5.1 テスト項目
- [ ] sample.pdfでの動作確認
- [ ] 0ページのPDFでエラーにならない
- [ ] 存在しないファイルで適切なエラー
- [ ] 100ページ以上のPDFでの性能確認

### 5.2 コード品質
- 関数は30行以内に収める
- 定数は大文字で定義
- 型ヒントを使用
- 日本語コメントで意図を明確に

---

## 6. リスク管理

### 6.1 想定されるリスク
1. **PDFの形式違い**: NextPublishing以外のPDF
   - 対策: 灰色の判定を厳密にする

2. **処理速度**: 大きなPDFでの遅延
   - 対策: ページ数警告を表示

3. **メモリ使用**: 巨大PDFでのメモリ不足
   - 対策: ページごとに処理してメモリ解放

### 6.2 将来の拡張性
- 視覚的検証の追加（Phase 2以降）
- バッチ処理対応
- 設定ファイルによるカスタマイズ

---

## 7. 実装開始チェックリスト

- [ ] 仕様書の最終確認完了
- [ ] 既存システムのバックアップ
- [ ] 開発環境の準備
- [ ] sample.pdfの存在確認
- [ ] 実装時間の確保（5時間）

## 8. 成果物

### Phase 1完了時の成果物
1. `overflow_detector.py` - メイン実装
2. `requirements_addon.txt` - 追加ライブラリ
3. `README.md` - 使用方法
4. テスト結果レポート

### ドキュメント
- 使用方法（README.md）
- Phase 2統合ガイド（別途作成）