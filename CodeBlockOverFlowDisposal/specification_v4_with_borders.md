# コードブロックはみ出し検出システム 仕様書 v4
## 複数タイプのコードブロック対応版

### 文書情報
- **バージョン**: 4.0.0
- **作成日**: 2025-01-28
- **対象システム**: 技術の泉シリーズ制作支援ツール 拡張機能
- **重要な変更**: 白背景・罫線囲みのコードブロックにも対応

---

## 1. 概要

### 1.1 目的
技術の泉シリーズのNextPublishing形式PDFにおいて、以下の2種類のコードブロックでテキストが右端からはみ出す問題を自動検出する：
1. **灰色背景タイプ**（従来型）
2. **白背景・罫線囲みタイプ**（新規対応）

### 1.2 検出対象の拡張
- **従来**: 灰色背景（RGB: 0.9, 0.9, 0.9）のコードブロック
- **追加**: 白背景で黒い罫線で囲まれたコードブロック

---

## 2. 技術要件

### 2.1 コードブロックの識別方法

#### タイプ1: 灰色背景（従来）
```python
# 識別条件
- 背景色: RGB(0.9, 0.9, 0.9) ± 0.02
- 矩形の塗りつぶし
- PyMuPDFのget_drawings()で'type'=='f'
```

#### タイプ2: 白背景・罫線囲み（新規）
```python
# 識別条件
- 背景色: 白またはなし
- 4辺が黒い罫線で囲まれている
- 罫線の太さ: 0.5-2.0pt程度
- pdfplumberのlinesまたはPyMuPDFのstroke情報を使用
```

### 2.2 検出アルゴリズム

#### Phase 1: 基本実装（1.5日）
1. **灰色背景の検出**（既存ロジック）
2. **罫線矩形の検出**（新規実装）
   - 水平線と垂直線のペアを検出
   - 閉じた矩形を形成する4本の線を特定
   - 矩形内部にコードが存在することを確認

#### Phase 2: 精度向上（将来）
- 罫線の途切れへの対応
- 入れ子構造の処理
- 部分的な罫線への対応

---

## 3. 実装方針

### 3.1 段階的アプローチ
1. **Step 1**: 灰色背景の検出（既存実装の活用）
2. **Step 2**: 罫線矩形の基本検出
3. **Step 3**: 両タイプの統合処理
4. **Step 4**: レポート生成の拡張

### 3.2 技術的課題と対策

#### 課題1: 罫線矩形の検出精度
- **問題**: 罫線が完全に閉じていない場合がある
- **対策**: 許容誤差を設定（線の端点が5pt以内なら接続とみなす）

#### 課題2: 処理時間の増加
- **問題**: 罫線解析により処理時間が増加
- **対策**: 
  - ページあたりの罫線数が多い場合は警告
  - タイプ別に処理を選択可能にする

### 3.3 出力仕様（更新版）
```
=== コードブロックはみ出し検出レポート ===
ファイル: sample2.pdf
検出日時: 2025-01-28 14:30:45
総ページ数: 100

■ 検出されたはみ出し: 5件

【灰色背景タイプ】
ページ 10: 5.5pt はみ出し
ページ 20: 15.3pt はみ出し（要修正）
ページ 48: 52.1pt はみ出し（致命的）

【罫線囲みタイプ】
ページ 60: 8.2pt はみ出し
ページ 75: 25.5pt はみ出し（要修正）

■ サマリー
  - 灰色背景: 3件
  - 罫線囲み: 2件
  - 合計: 5件

処理時間: 18.5秒
```

---

## 4. リスクと制約

### 4.1 技術的リスク
1. **罫線検出の複雑性**
   - 表の罫線との区別が困難
   - 入れ子構造の処理が複雑

2. **性能への影響**
   - 罫線解析により処理時間が1.5-2倍に

### 4.2 実装の優先順位
1. **必須（Day 1）**
   - 灰色背景の検出（既存）
   - 単純な罫線矩形の検出
   - 基本的なレポート

2. **推奨（Day 1.5）**
   - 罫線検出の精度向上
   - タイプ別の集計

3. **将来（Phase 2）**
   - 複雑な罫線パターン対応
   - GUI統合

---

## 5. 成功基準

### 5.1 機能要件
- [ ] sample.pdfの灰色背景はみ出しを検出
- [ ] sample2.pdfの罫線囲みはみ出しを検出
- [ ] 両タイプを区別してレポート出力

### 5.2 性能要件
- [ ] 100ページを90秒以内で処理（罫線解析込み）
- [ ] メモリ使用量2GB以内

---

## 6. 実装スケジュール

### Day 1（8時間）
1. 既存の灰色背景検出の実装（2時間）
2. 罫線検出の基本実装（4時間）
3. 統合とテスト（2時間）

### Day 1.5（4時間）※必要に応じて
1. 罫線検出の精度向上（2時間）
2. エッジケース対応（1時間）
3. パフォーマンス調整（1時間）