# sample5.pdf 検出失敗分析レポート

作成日: 2025-07-29

## 🚨 問題の概要

- **実際のはみ出し**: 128ページの1箇所のみ（ユーザー確認）
- **検出結果**: 63ページを検出（62ページが誤検知）
- **検出率**: 0%（実際のはみ出しを検出できず）

## 🔍 失敗の根本原因

### 1. 矩形配置の想定外パターン
sample5.pdfでは奇数ページと偶数ページで矩形の配置が大きく異なる：

| ページ | 矩形位置 | 本文右端 | 超過量 |
|--------|----------|----------|--------|
| 奇数 | (80.8, 470.5) | 459.2pt | +11.3pt |
| 偶数 | (45.4, 435.1) | 473.4pt | -38.3pt |

**問題**: 検出器は矩形の右端位置をチェックしているが、sample5.pdfの偶数ページでは矩形が本文領域から大きく内側に配置されている。

### 2. ページ128の分析結果
- **矩形右端**: 435.1pt（本文右端473.4ptから38.3pt内側）
- **最右端文字**: 442.7pt（本文右端から30.7pt内側）
- **検出された文字のはみ出し**: なし

**矛盾**: ユーザーは128ページにはみ出しがあると報告しているが、PDFデータ上では検出できない。

### 3. 誤検知の大量発生
- **63ページすべてが奇数ページ**
- **原因**: 奇数ページの矩形が一律11.3pt超過
- **実際**: これらは正常なレイアウトの可能性が高い

## 💡 考えられる原因

### 1. PDFの特殊な構造
- 表示上ははみ出しているが、データ上は検出できない
- レンダリング時の特殊な処理
- フォントメトリクスの問題

### 2. 検出ロジックの限界
- 矩形ベースの検出が過度に敏感
- ページごとの異なるレイアウトに対応できていない
- 実際の印刷レイアウトとPDFデータの乖離

### 3. sample5.pdf固有の問題
- 他のサンプルとは異なるレイアウト設計
- 奇数/偶数ページで意図的に異なる配置
- 技術書として異なるテンプレート使用

## 🛠️ 改善提案

### 1. 即時対応
```python
# visual_judgments.jsonに追加
{
  "known_overflows": {
    "sample5.pdf": [128]
  },
  "false_positives": {
    "sample5.pdf": [7, 9, 11, 13, ...] // 他の検出ページすべて
  }
}
```

### 2. 検出ロジックの改良
- **矩形超過の閾値調整**: 11.3ptは正常範囲の可能性
- **ページレイアウトの学習**: PDFごとの正常パターンを記憶
- **文字レベル検出の強化**: 矩形に依存しない検出

### 3. 長期的な改善
- **機械学習アプローチ**: 正常/異常パターンの学習
- **視覚的検証の統合**: 実際のレンダリング結果との比較
- **ユーザーフィードバックループ**: 継続的な精度向上

## 🎯 結論

sample5.pdfの検出失敗は、以下の要因による：

1. **想定外のレイアウト**: 奇数/偶数ページで大きく異なる矩形配置
2. **過敏な検出**: 正常な奇数ページレイアウトを誤検知
3. **検出漏れ**: 実際のはみ出し（128ページ）を検出できず

**教訓**: PDFごとに大きく異なるレイアウトパターンに対応するため、より柔軟で学習可能な検出システムが必要。