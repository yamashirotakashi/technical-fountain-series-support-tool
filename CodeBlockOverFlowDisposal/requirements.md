# コードブロックはみ出し検出システム 要件仕様書

## プロジェクト概要
**プロジェクト名**: CodeBlockOverflowDisposal  
**目的**: 技術の泉シリーズPDFにおけるコードブロックの本文幅はみ出し自動検出  
**アプローチ**: OCRベースのテキスト位置解析  

## 機能要件

### FR-001: PDF解析機能 【必須】
**説明**: PDFファイルを読み込み、各ページを解析する
- **入力**: PDFファイルパス
- **出力**: ページ別解析データ
- **制約**: B5判（182×257mm）のPDFに対応

### FR-002: OCRテキスト認識 【必須】
**説明**: 各ページでOCRを実行してテキスト位置情報を取得
- **エンジン**: Tesseract OCR 4.0以上
- **言語**: 日本語・英語混在対応（jpn+eng）
- **解像度**: 300 DPI
- **出力**: テキスト内容と座標情報

### FR-003: マージン判定 【必須】
**説明**: 左右ページで異なるマージン設定に対応
- **左ページ（偶数）**: 左20mm / 右15mm
- **右ページ（奇数）**: 左15mm / 右20mm
- **計算精度**: 1px単位

### FR-004: はみ出し判定 【必須】
**説明**: テキストが本文幅を超えているかを判定
- **判定基準**: 本文エリア右端 + 5px超過
- **対象**: 本文エリア内のテキストのみ
- **除外**: ページ番号、ヘッダー、フッター

### FR-005: 結果出力 【必須】
**説明**: 検出結果をレポート形式で出力
- **標準出力**: コンソール表示
- **ファイル出力**: テキストファイル（オプション）
- **形式**: はみ出しページ番号のリスト

### FR-006: エラーハンドリング 【必須】
**説明**: 各種エラー状況に適切に対応
- **ファイル未発見**: 明確なエラーメッセージ
- **OCRエラー**: ページスキップして継続
- **メモリ不足**: ページ単位でメモリ解放

## 非機能要件

### NFR-001: 性能要件
- **処理速度**: 3秒/ページ以下
- **メモリ使用量**: 300MB/100ページ以下
- **レスポンス**: 100ページPDFを5分以内で処理

### NFR-002: 精度要件
- **検出率**: 95%以上（はみ出しありページの正しい検出）
- **誤検出率**: 5%以下（はみ出しなしページの誤検出）

### NFR-003: 可用性要件
- **エラー回復**: 単一ページエラーで全体停止しない
- **ログ出力**: デバッグ情報の適切な出力

### NFR-004: 保守性要件
- **コード品質**: PEP 8準拠、型ヒント使用
- **文書化**: 関数・クラスのdocstring完備
- **テスト**: 主要機能のユニットテスト

## システム要件

### 環境要件
- **Python**: 3.8以上
- **OS**: Windows, Linux, macOS対応
- **依存関係**: requirements_ocr.txt参照

### 外部依存
- **Tesseract OCR**: システムレベルインストール必須
- **言語データ**: 日本語パック（tesseract-ocr-jpn）

## 入出力仕様

### 入力仕様
```bash
python overflow_detector_ocr.py <pdf_file> [options]
```
- `pdf_file`: 解析対象PDFファイルパス（必須）
- `-o, --output`: レポート出力ファイルパス（オプション）
- `--lang`: OCR言語設定（デフォルト: jpn+eng）

### 出力仕様
```
=== コードブロックはみ出し検出結果 (OCR版) ===
ファイル: sample.pdf
検出日時: 2025-01-28 10:30:45
ページサイズ: B5 (182×257mm)
左ページマージン: 左20mm / 右15mm
右ページマージン: 左15mm / 右20mm

本文幅からはみ出しているページ:
10, 20, 48

検出数: 3ページ
処理時間: 45.2秒
```

## 制約事項

### 技術制約
- OCRエンジンの認識精度に依存
- PDF品質（解像度、文字の鮮明さ）に影響される
- 処理時間は画像処理ベースより長い

### 運用制約
- Tesseract OCRの事前インストールが必要
- 大容量PDFではメモリ消費が大きい

## 品質基準

### 受入基準
1. **機能テスト**: 全FR要件を満たす
2. **性能テスト**: 全NFR要件を満たす
3. **回帰テスト**: 既存サンプルPDFで期待結果を出力
4. **エラーテスト**: 異常系でクラッシュしない

### 品質メトリクス
- **コードカバレッジ**: 80%以上
- **複雑度**: 関数あたりCyclomatic Complexity 10以下
- **保守性指数**: Maintainability Index 60以上

## 受入テストケース

### TC-001: 正常系 - はみ出しあり
- **前提**: はみ出しを含むPDFファイル
- **実行**: 正常な検出処理
- **期待**: 該当ページ番号が正しく出力される

### TC-002: 正常系 - はみ出しなし
- **前提**: はみ出しのないPDFファイル
- **実行**: 正常な検出処理
- **期待**: 「はみ出しは検出されませんでした」と表示

### TC-003: 異常系 - ファイル未存在
- **前提**: 存在しないPDFファイルパス
- **実行**: エラーハンドリング
- **期待**: 適切なエラーメッセージでプログラム終了

### TC-004: 境界値 - 大容量PDF
- **前提**: 200ページ以上のPDFファイル
- **実行**: 性能要件内での処理
- **期待**: メモリエラーなく完了

## 今後の拡張要件

### 将来要件（スコープ外）
- GUI版インターフェース
- バッチ処理機能
- 詳細な統計レポート
- 機械学習による精度向上