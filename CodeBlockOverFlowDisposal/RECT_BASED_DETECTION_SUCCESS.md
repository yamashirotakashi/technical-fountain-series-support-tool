# 矩形基準検出の成功分析

作成日: 2025-07-29

## 🎯 検出結果の劇的改善

### 従来手法との比較
| 検出手法 | 検出ページ数 | 正解（128p） | 誤検知 | 精度 |
|---------|-------------|------------|---------|------|
| v5（本文領域基準） | 63ページ | ✗ | 63ページ | 0% |
| 矩形基準 | 3ページ | ✓ | 2ページ | 33.3% |

## 🔍 成功の要因

### 1. 発想の転換
- **従来**: 本文領域（ページマージン）からのはみ出しを検出
- **新手法**: コードブロック（グレー背景矩形）からのはみ出しを検出

### 2. sample5.pdfの特殊性への対応
```
奇数ページ: 矩形が本文領域を超えている（正常なレイアウト）
偶数ページ: 矩形が本文領域内に収まっている

→ 本文領域基準では奇数ページすべてが誤検知
→ 矩形基準なら正確に検出可能
```

### 3. 検出された内容
- **ページ60**: `nager]::SecurityProtocol` (110.2pt超過)
- **ページ128**: `n)` (7.6pt超過) ✓ 正解
- **ページ129**: `n)`, `an)` (7.5-12.2pt超過)

## 💡 矩形基準検出の利点

### 1. PDFレイアウトの多様性に対応
- 本文領域の定義が異なるPDFでも動作
- 奇数/偶数ページの異なるレイアウトに影響されない
- 実際の視覚的な「はみ出し」により近い

### 2. 誤検知の大幅削減
- 63ページ → 3ページ（95%削減）
- 正常なレイアウトを誤検知しない
- コードブロック内のみを対象とするため精度向上

### 3. シンプルで直感的
- 「グレー背景からはみ出している」という視覚的に明確な基準
- ユーザーの認識と一致
- 実装もシンプル

## 🛠️ 推奨される最終実装

### ハイブリッドアプローチ v6
```python
class HybridDetectorV6:
    def detect(self, page):
        # 1. 矩形基準検出（最優先）
        rect_overflows = detect_rect_overflow(page)
        
        # 2. 視覚的判断（ユーザーフィードバック）
        visual_overflows = check_visual_judgments(page)
        
        # 3. 本文領域基準（補助的、閾値を緩く）
        page_overflows = detect_page_overflow(page, threshold=20)
        
        return combine_results(rect_overflows, visual_overflows, page_overflows)
```

## 📊 各サンプルでの推定効果

| PDFファイル | 実際のはみ出し | v5検出 | 矩形基準（推定） |
|------------|---------------|--------|----------------|
| sample.pdf | 1ページ | 未検証 | 1-3ページ |
| sample2.pdf | 2ページ | 未検証 | 2-5ページ |
| sample3.pdf | 24ページ | 24ページ | 23ページ |
| sample4.pdf | 6+ページ | 29ページ | 6ページ |
| sample5.pdf | 1ページ | 63ページ | 3ページ |

## 🎆 結論

矩形基準検出は、PDFの実際の視覚的構造に基づいた検出を実現し、従来手法の問題を解決しました。特にsample5.pdfのような特殊なレイアウトに対して有効であり、Phase 2での実装に強く推奨されます。

### 次のステップ
1. visual_judgments.jsonの更新（sample5.pdfの誤検知を記録）
2. HybridDetectorV6の実装
3. 全サンプルでの検証
4. Phase 2統合準備