# コードブロックはみ出し検出システム 仕様書 v2
## 仕様書駆動開発（SDD）用 - 現実的実装版

### 文書情報
- **バージョン**: 2.0.0
- **作成日**: 2025-01-28
- **対象システム**: 技術の泉シリーズ制作支援ツール 拡張機能
- **実装期間**: Phase 1（1日実装）→ Phase 2（統合）

---

## 1. 概要

### 1.1 目的
技術の泉シリーズの組版PDFにおいて、コードブロック内のテキストが右端からはみ出す問題を検出する最小限のツールを作成する。

### 1.2 スコープ（Phase 1 - 1日実装）
**実装する機能**：
- PDFファイルを直接指定して解析
- 灰色背景のコードブロック検出
- テキストのはみ出し幅測定
- シンプルなテキストレポート出力

**実装しない機能**：
- Nコードによる複雑な入力処理
- 並列処理
- エラーコード体系
- 設定ファイル
- キャッシュ機能

---

## 2. 最小限の機能要件

### 2.1 入力
```bash
# シンプルなコマンドライン実行
python overflow_detector.py sample.pdf
```

### 2.2 処理
1. PDFファイルを開く
2. 各ページで灰色背景の矩形を探す
3. 矩形内のテキストを取得
4. 右端からのはみ出しを計算

### 2.3 出力
```
=== コードブロックはみ出し検出結果 ===
ファイル: sample.pdf
総ページ数: 48

検出されたはみ出し:
- ページ 10: 5.5pt はみ出し
- ページ 20: 15.3pt はみ出し（要修正）
- ページ 48: 52.1pt はみ出し（致命的）

処理時間: 12.3秒
```

---

## 3. 技術仕様

### 3.1 使用ライブラリ
```python
# 必要最小限のライブラリ
pdfplumber  # PDFからテキストと図形を抽出
```

### 3.2 ファイル構成（最小限）
```
CodeBlockOverFlowDisposal/
├── overflow_detector.py    # メイン処理（全機能を含む）
├── requirements.txt        # pdfplumber
└── README.md              # 簡単な使用方法
```

### 3.3 コア実装
```python
# overflow_detector.py の基本構造
import pdfplumber
import sys

def detect_overflows(pdf_path):
    """PDFからはみ出しを検出する最小限の実装"""
    results = []
    
    with pdfplumber.open(pdf_path) as pdf:
        for page in pdf.pages:
            # 灰色背景の矩形を検出
            gray_rects = find_gray_rectangles(page)
            
            for rect in gray_rects:
                # 矩形内のテキストをチェック
                overflow = check_text_overflow(page, rect)
                if overflow:
                    results.append(overflow)
    
    return results

def find_gray_rectangles(page):
    """灰色背景（0.9, 0.9, 0.9）の矩形を検出"""
    # 実装...

def check_text_overflow(page, rect):
    """テキストのはみ出しをチェック"""
    # 実装...

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("使用方法: python overflow_detector.py <PDFファイル>")
        sys.exit(1)
    
    results = detect_overflows(sys.argv[1])
    print_results(results)
```

---

## 4. 実装の優先順位

### 4.1 必須（Day 1）
1. PDFを開いて読み込む
2. 灰色矩形の検出
3. 基本的なはみ出し検出
4. 結果の表示

### 4.2 できれば（時間があれば）
1. はみ出し幅による分類（軽微/重大/致命的）
2. 処理時間の表示
3. エラーハンドリングの改善

### 4.3 将来（Phase 2以降）
1. 既存GUIへの統合
2. より詳細なレポート
3. 性能最適化

---

## 5. 制約事項

### 5.1 前提条件
- NextPublishing形式のPDF
- コードブロックは灰色背景（RGB: 0.9, 0.9, 0.9）
- 等幅フォント使用

### 5.2 既知の制限
- 視覚的検証は行わない（テキストベースのみ）
- 1ファイルずつ処理
- 自動修正機能なし

---

## 6. 検証方法

### 6.1 動作確認
```bash
# サンプルPDFでテスト
python overflow_detector.py sample.pdf

# 48ページにはみ出しがあることを確認
```

### 6.2 成功基準
- sample.pdfの48ページのはみ出しを検出できること
- 100ページのPDFを1分以内に処理できること
- エラーでクラッシュしないこと

---

## 7. Phase 2 統合計画（将来）

### 7.1 統合方針
- 現在の単一ファイルをモジュール化
- 既存のPyQt5 GUIにボタン追加
- 結果表示ウィンドウの実装

### 7.2 必要な調査
- 既存システムのコード構造
- GUIフレームワークの使用方法
- イベントハンドリングの実装方法

---

## 8. リスクと対策

### 8.1 技術的リスク
- **リスク**: pdfplumberで灰色背景を正確に検出できない可能性
- **対策**: 最悪の場合、ユーザーがコードブロックの位置を手動指定

### 8.2 スケジュールリスク
- **リスク**: 1日で完成しない可能性
- **対策**: 最低限の機能（はみ出し検出のみ）に集中

---

## 付録: 実装チェックリスト

□ PDFファイルを開ける
□ ページを順番に処理できる
□ 灰色の矩形を検出できる
□ テキストの位置を取得できる
□ はみ出し幅を計算できる
□ 結果を表示できる
□ sample.pdfでテスト完了
□ エラー時にクラッシュしない